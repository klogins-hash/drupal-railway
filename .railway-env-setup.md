# Railway Environment Variable Setup for Service-to-Service Communication

## How Railway Services Communicate

In Railway, services in the same project communicate through **private network URLs** that are automatically provided as environment variables.

## PostgreSQL Service Variables (Auto-Generated by Railway)

When you add the PostgreSQL plugin, Railway automatically creates these variables:

```
DATABASE_URL          # Full connection string: postgresql://user:pass@host:5432/dbname
PGHOST               # PostgreSQL host (service name)
PGPORT               # PostgreSQL port: 5432
PGUSER               # PostgreSQL username
PGPASSWORD           # PostgreSQL password
PGDATABASE           # PostgreSQL database name
```

## Drupal Service Environment Variables

In the **Drupal Service Settings**, add these variables to reference the PostgreSQL service:

### Option 1: Using Individual Variables (Recommended)

```
DRUPAL_DB_HOST=${{Postgres.PGHOST}}
DRUPAL_DB_PORT=${{Postgres.PGPORT}}
DRUPAL_DB_NAME=${{Postgres.PGDATABASE}}
DRUPAL_DB_USER=${{Postgres.PGUSER}}
DRUPAL_DB_PASSWORD=${{Postgres.PGPASSWORD}}
DRUPAL_DRIVER=pgsql
```

**Important:** Replace `Postgres` with your actual PostgreSQL service name if different.

### Option 2: Using Database URL

```
DRUPAL_DATABASE_URL=${{Postgres.DATABASE_URL}}
DRUPAL_DRIVER=pgsql
```

## Setup Steps in Railway Dashboard

1. **Go to Your Project** → drupal-railway

2. **Select Drupal Service**
   - Click on the Drupal service in the canvas
   - Go to the "Variables" tab

3. **Add Variables**
   - Click "Add Variable"
   - Enter each variable name and value from above
   - Use the `${{ServiceName.VARIABLE}}` syntax to reference other services

4. **Link Services** (if not auto-linked)
   - Railway should automatically link services when you reference them
   - You can manually verify: Service → Settings → See "Linked Services"

5. **Redeploy**
   - Once variables are set, trigger a new deployment
   - Push to GitHub or use `railway deploy`
   - Monitor logs to verify connection success

## Verification

### Check Connection in Drupal Service Logs

You should see something like:
```
[notice] Apache/2.4.x (Debian)
[notice] Server initialized
```

If PostgreSQL is not accessible:
```
ERROR: could not translate host name "postgres" to address: Name or service not known
```

### SSH into Drupal and Test

```bash
railway ssh --project=<PROJECT_ID> --service=<DRUPAL_SERVICE_ID>

# Inside the container:
apt-get update && apt-get install -y postgresql-client
pg_isready -h $DRUPAL_DB_HOST -p $DRUPAL_DB_PORT -U $DRUPAL_DB_USER
```

Expected output: `accepting connections`

### Check PostgreSQL Directly

```bash
railway ssh --project=<PROJECT_ID> --service=<POSTGRES_SERVICE_ID>

# Inside PostgreSQL container:
psql -U $PGUSER -d $PGDATABASE -c "SELECT 1;"
```

Expected output: Should return `1`

## Network Architecture

```
┌─────────────────────────────────────────────┐
│ Railway Private Network                     │
├─────────────────────────────────────────────┤
│                                             │
│  ┌──────────────────┐   ┌────────────────┐ │
│  │    Drupal        │   │  PostgreSQL    │ │
│  │   0.0.0.0:80     │   │  0.0.0.0:5432 │ │
│  │                  │←→ │                │ │
│  │ (Service URL)    │   │ (Service URL)  │ │
│  └──────────────────┘   └────────────────┘ │
│                                             │
└─────────────────────────────────────────────┘
         ↕
    Public Internet
    (via Railway Domain)
```

## Troubleshooting

### "Connection refused" error
- Ensure PostgreSQL service is running and healthy
- Check variables are spelled correctly
- Verify PostgreSQL service name in variable references

### "Database does not exist" error
- PostgreSQL is accessible but database name is wrong
- Check `PGDATABASE` or `DRUPAL_DB_NAME` is correct
- Default: `railway` or check PostgreSQL logs

### "Authentication failed" error
- Username or password mismatch
- Verify `PGUSER` and `PGPASSWORD` match PostgreSQL plugin settings
- Check for typos in environment variables

### Variables not updating after set
- Changes take effect on next deployment
- Push to GitHub or use `railway deploy`
- New pods will get the variables

## Key Points

✅ Use `${{ServiceName.VARIABLE}}` to reference other services
✅ Drupal and PostgreSQL communicate through private network
✅ No public IPs needed for service-to-service communication
✅ Service URLs are automatically generated by Railway
✅ Always use internal PostgreSQL port 5432
✅ Verify connectivity in logs before troubleshooting application code
